<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å¸¸æ”¯å‡ºè®°å½•è¡¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 { font-size: 28px; margin-bottom: 10px; }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-card h3 { color: #666; font-size: 14px; margin-bottom: 8px; }

        .stat-card .amount {
            color: #667eea;
            font-size: 24px;
            font-weight: bold;
        }

        .input-section {
            padding: 30px;
            border-bottom: 1px solid #e0e0e0;
        }

        .input-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-group { display: flex; flex-direction: column; }

        .input-group label {
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
            font-weight: 500;
        }

        .input-group input, .input-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: transform 0.2s;
            white-space: nowrap;
        }

        .btn:hover { transform: translateY(-2px); }

        .btn-danger { background: #ff4757; }
        .btn-danger:hover { background: #ff3838; }

        .btn-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .table-section {
            padding: 30px;
            overflow-x: auto;
        }

        table { width: 100%; border-collapse: collapse; }
        thead { background: #f8f9fa; }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e0e0e0;
        }

        td { padding: 12px; border-bottom: 1px solid #f0f0f0; }

        tbody tr:hover { background: #f8f9fa; }

        .category-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .delete-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-btn:hover { background: #ff3838; }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* ====== ç‚¹å‡»å•å…ƒæ ¼ç¼–è¾‘ï¼šè¿½åŠ æ ·å¼ ====== */
        .cell-editable {
            cursor: pointer;
            position: relative;
        }
        .cell-editable:hover {
            background: #f3f4ff;
        }
        .inline-editor {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #667eea;
            border-radius: 6px;
            font-size: 14px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸ’° æ—¥å¸¸æ”¯å‡ºè®°å½•è¡¨</h1>
        <p>è®°å½•æ¯ä¸€ç¬”æ”¯å‡º,æŒæ§è´¢åŠ¡çŠ¶å†µ</p>
    </div>

    <div class="stats">
        <div class="stat-card">
            <h3>æœ¬æœˆæ€»æ”¯å‡º</h3>
            <div class="amount" id="monthTotal">Â¥0.00</div>
        </div>
        <div class="stat-card">
            <h3>ä»Šæ—¥æ”¯å‡º</h3>
            <div class="amount" id="todayTotal">Â¥0.00</div>
        </div>
        <div class="stat-card">
            <h3>è®°å½•æ¡æ•°</h3>
            <div class="amount" id="recordCount">0</div>
        </div>
    </div>

    <div class="input-section">
        <div class="input-form">
            <div class="input-group">
                <label>æ—¥æœŸ</label>
                <input type="date" id="dateInput" required>
            </div>
            <div class="input-group">
                <label>åˆ†ç±»</label>
                <select id="categoryInput">
                    <option value="é¤é¥®">ğŸ” æ—©ä¸­æ™šé¤</option>
                    <option value="å’–å•¡æ°´">â˜• å’–å•¡æ°´</option>
                    <option value="äº¤é€š">ğŸš— äº¤é€š</option>
                    <option value="åœè½¦">ğŸ…¿ï¸ åœè½¦</option>
                    <option value="åŠ å·¥">ğŸ­ åŠ å·¥</option>
                    <option value="ç§Ÿè½¦">ğŸš™ ç§Ÿè½¦</option>
                    <option value="é«˜é€Ÿ">ğŸ›£ï¸ é«˜é€Ÿ</option>
                    <option value="æ—¥ç»™">ğŸ’° æ—¥ç»™</option>
                    <option value="å…¶ä»–">ğŸ“¦ å…¶ä»–</option>
                </select>
            </div>
            <div class="input-group">
                <label>é‡‘é¢(å††)</label>
                <input type="number" id="amountInput" step="0.01" placeholder="0.00" required>
            </div>
            <div class="input-group">
                <label>å¤‡æ³¨</label>
                <input type="text" id="noteInput" placeholder="å¯é€‰">
            </div>
        </div>

        <div class="btn-row">
            <button class="btn" onclick="addExpense()">æ·»åŠ æ”¯å‡º</button>
            <button class="btn" onclick="exportCSV()">å¯¼å‡º CSV</button>
            <button class="btn" onclick="exportExcel()">å¯¼å‡º Excel</button>
            <button class="btn btn-danger" onclick="clearAll()">æ¸…ç©ºæ•°æ®</button>
        </div>
    </div>

    <div class="table-section">
        <table>
            <thead>
            <tr>
                <th>æ—¥æœŸ</th>
                <th>åˆ†ç±»</th>
                <th>é‡‘é¢</th>
                <th>å¤‡æ³¨</th>
                <th>æ“ä½œ</th>
            </tr>
            </thead>
            <tbody id="expenseTable">
            <tr class="no-data">
                <td colspan="5">æš‚æ— æ”¯å‡ºè®°å½•,å¼€å§‹æ·»åŠ å§!</td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // ====== æ•°æ®æŒä¹…åŒ–ï¼šlocalStorage ======
    const STORAGE_KEY = 'expenses_v1';

    let expenses = loadExpenses();

    function loadExpenses() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            const arr = raw ? JSON.parse(raw) : [];
            return Array.isArray(arr) ? arr : [];
        } catch (e) {
            return [];
        }
    }

    function saveExpenses() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(expenses));
    }

    // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
    document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];

    const categoryColors = {
        'é¤é¥®': '#ff6b6b',
        'å’–å•¡æ°´': '#a55eea',
        'äº¤é€š': '#4ecdc4',
        'åœè½¦': '#576574',
        'åŠ å·¥': '#f0932b',
        'ç§Ÿè½¦': '#22a6b3',
        'é«˜é€Ÿ': '#6ab04c',
        'æ—¥ç»™': '#f9ca24',
        'å…¶ä»–': '#95afc0'
    };

    function addExpense() {
        const date = document.getElementById('dateInput').value;
        const category = document.getElementById('categoryInput').value;
        const amount = Number(document.getElementById('amountInput').value);
        const note = document.getElementById('noteInput').value;

        // æ ¡éªŒï¼šä¸è¦ç”¨ !amountï¼ˆ0 ä¼šè¢«å½“ falseï¼‰ï¼Œç”¨ isFinite
        if (!date || !Number.isFinite(amount) || amount <= 0) {
            alert('è¯·å¡«å†™æ—¥æœŸå’Œæœ‰æ•ˆé‡‘é¢!');
            return;
        }

        const expense = {
            id: Date.now(),
            date,
            category,
            amount,
            note
        };

        expenses.unshift(expense);
        saveExpenses();
        updateTable();
        updateStats();

        // æ¸…ç©ºè¾“å…¥
        document.getElementById('amountInput').value = '';
        document.getElementById('noteInput').value = '';
    }

    function deleteExpense(id) {
        expenses = expenses.filter(e => e.id !== id);
        saveExpenses();
        updateTable();
        updateStats();

        // å¦‚æœæ­£åœ¨ç¼–è¾‘æŸæ ¼ï¼Œä¸”è¯¥è¡Œè¢«åˆ ï¼Œç›´æ¥å–æ¶ˆç¼–è¾‘æ€å¹¶é‡ç»˜
        if (editingCell && editingCell.id === id) {
            editingCell = null;
            updateTable();
        }
    }

    function clearAll() {
        if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
        expenses = [];
        saveExpenses();
        updateTable();
        updateStats();
    }

    // ====== ç‚¹å‡»å•å…ƒæ ¼ç¼–è¾‘ï¼šæ ¸å¿ƒé€»è¾‘ ======
    let editingCell = null; // { id, field, oldValue }

    function beginInlineEdit(id, field) {
        // å¦‚æœå·²æœ‰å…¶ä»–æ ¼åœ¨ç¼–è¾‘ï¼Œå…ˆå–æ¶ˆï¼ˆä¹Ÿå¯ä»¥æ”¹æˆå…ˆä¿å­˜ï¼‰
        if (editingCell) {
            cancelInlineEdit();
        }

        const exp = expenses.find(e => e.id === id);
        if (!exp) return;

        const cell = document.querySelector(`td[data-id="${id}"][data-field="${field}"]`);
        if (!cell) return;

        const oldValue = exp[field] ?? '';
        editingCell = { id, field, oldValue };

        const input = document.createElement('input');
        input.className = 'inline-editor';

        if (field === 'amount') {
            input.type = 'number';
            input.step = '0.01';
            input.value = Number(exp.amount || 0).toFixed(2);
        } else {
            input.type = 'text';
            input.value = String(exp.note || '');
        }

        cell.innerHTML = '';
        cell.appendChild(input);
        input.focus();
        input.select();

        // Enter ä¿å­˜ï¼›Esc å–æ¶ˆ
        input.addEventListener('keydown', (ev) => {
            if (ev.key === 'Enter') {
                ev.preventDefault();
                commitInlineEdit(input.value);
            } else if (ev.key === 'Escape') {
                ev.preventDefault();
                cancelInlineEdit();
            }
        });

        // å¤±ç„¦ä¿å­˜ï¼ˆç‚¹å‡»å…¶ä»–åœ°æ–¹ä¹Ÿèƒ½ä¿å­˜ï¼‰
        input.addEventListener('blur', () => {
            if (editingCell) commitInlineEdit(input.value);
        });
    }

    function commitInlineEdit(newValueRaw) {
        if (!editingCell) return;

        const { id, field } = editingCell;
        const idx = expenses.findIndex(e => e.id === id);
        if (idx === -1) {
            editingCell = null;
            updateTable();
            return;
        }

        if (field === 'amount') {
            const amount = Number(String(newValueRaw).trim());
            if (!Number.isFinite(amount) || amount <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢ï¼ˆ> 0ï¼‰');
                cancelInlineEdit();
                return;
            }
            expenses[idx].amount = amount;
        } else {
            expenses[idx].note = String(newValueRaw ?? '').trim();
        }

        saveExpenses();
        editingCell = null;
        updateTable();
        updateStats();
    }

    function cancelInlineEdit() {
        if (!editingCell) return;
        editingCell = null;
        updateTable();
    }

    function updateTable() {
        const tbody = document.getElementById('expenseTable');

        if (expenses.length === 0) {
            tbody.innerHTML = '<tr class="no-data"><td colspan="5">æš‚æ— æ”¯å‡ºè®°å½•,å¼€å§‹æ·»åŠ å§!</td></tr>';
            return;
        }

        tbody.innerHTML = expenses.map(exp => `
            <tr>
                <td>${exp.date}</td>
                <td>
                  <span class="category-badge"
                        style="background: ${categoryColors[exp.category]}22; color: ${categoryColors[exp.category]}">
                        ${exp.category}
                  </span>
                </td>

                <!-- é‡‘é¢ï¼šç‚¹å‡»ç¼–è¾‘ -->
                <td class="cell-editable"
                    data-id="${exp.id}"
                    data-field="amount"
                    style="color: #e74c3c; font-weight: 600;"
                    onclick="beginInlineEdit(${exp.id}, 'amount')">
                    Â¥${Number(exp.amount).toFixed(2)}
                </td>

                <!-- å¤‡æ³¨ï¼šç‚¹å‡»ç¼–è¾‘ -->
                <td class="cell-editable"
                    data-id="${exp.id}"
                    data-field="note"
                    onclick="beginInlineEdit(${exp.id}, 'note')">
                    ${exp.note ? escapeHtml(exp.note) : '-'}
                </td>

                <td>
                    <button class="delete-btn" onclick="deleteExpense(${exp.id})">åˆ é™¤</button>
                </td>
            </tr>
        `).join('');
    }

    function updateStats() {
        const today = new Date().toISOString().split('T')[0];
        const currentMonth = new Date().toISOString().slice(0, 7);

        const todayTotal = expenses
            .filter(e => e.date === today)
            .reduce((sum, e) => sum + Number(e.amount || 0), 0);

        const monthTotal = expenses
            .filter(e => String(e.date || '').startsWith(currentMonth))
            .reduce((sum, e) => sum + Number(e.amount || 0), 0);

        document.getElementById('todayTotal').textContent = `Â¥${todayTotal.toFixed(2)}`;
        document.getElementById('monthTotal').textContent = `Â¥${monthTotal.toFixed(2)}`;
        document.getElementById('recordCount').textContent = expenses.length;
    }

    // é˜²æ­¢å¤‡æ³¨é‡Œè¾“å…¥ç‰¹æ®Šå­—ç¬¦å¯¼è‡´è¡¨æ ¼æ˜¾ç¤ºé—®é¢˜
    function escapeHtml(str) {
        return String(str)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#039;');
    }

    // ====== å¯¼å‡º CSV ======
    function exportCSV() {
        if (!expenses || expenses.length === 0) {
            alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
            return;
        }

        const headers = ['æ—¥æœŸ', 'åˆ†ç±»', 'é‡‘é¢', 'å¤‡æ³¨'];
        const rows = expenses.map(e => [
            e.date,
            e.category,
            (Number(e.amount) || 0).toFixed(2),
            e.note || ''
        ]);

        const escapeCSV = (v) => {
            const s = String(v ?? '');
            if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
            return s;
        };

        const csv = [headers, ...rows]
            .map(row => row.map(escapeCSV).join(','))
            .join('\r\n');

        const bom = '\uFEFF';
        const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });

        const filename = `expense_${formatDateYYYYMMDD(new Date())}.csv`;
        downloadBlob(blob, filename);
    }

    // ====== å¯¼å‡º Excelï¼ˆSheetJSï¼‰ ======
    function exportExcel() {
        if (!expenses || expenses.length === 0) {
            alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
            return;
        }
        if (typeof XLSX === 'undefined') {
            alert('Excel å¯¼å‡ºåº“æœªåŠ è½½ï¼Œè¯·ç¨ååˆ·æ–°é¡µé¢å†è¯•ã€‚');
            return;
        }

        const data = expenses.map(e => ({
            'æ—¥æœŸ': e.date,
            'åˆ†ç±»': e.category,
            'é‡‘é¢': (Number(e.amount) || 0).toFixed(2),
            'å¤‡æ³¨': e.note || ''
        }));

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'æ”¯å‡ºè®°å½•');

        const filename = `expense_${formatDateYYYYMMDD(new Date())}.xlsx`;
        XLSX.writeFile(wb, filename);
    }

    // ====== å·¥å…·å‡½æ•° ======
    function formatDateYYYYMMDD(d) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}${m}${day}`;
    }

    function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    // é¡µé¢åŠ è½½åç«‹å³æ¸²æŸ“å·²æœ‰æ•°æ®
    updateTable();
    updateStats();
</script>

<!-- SheetJSï¼šç”¨äºå¯¼å‡º .xlsxï¼ˆGitHub Pages å¯ç”¨ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</body>
</html>
